<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Galgame Agent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Playfair+Display:wght@600&family=ZCOOL+XiaoWei&display=swap"
        rel="stylesheet"
    />
    <style>
:root {
    --bg-overlay: rgba(12, 14, 32, 0.55);
    --accent: #ff7bc1;
    --accent-strong: #ff459e;
    --accent-cool: #6bc7ff;
    --accent-gold: #ffd99f;
    --text-primary: #f6f7ff;
    --text-secondary: rgba(255, 255, 255, 0.74);
    --font-sans: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
    --font-serif: 'Playfair Display', 'ZCOOL XiaoWei', 'STKaiti', serif;
    --panel-bg: rgba(20, 24, 52, 0.86);
    --panel-border: rgba(255, 255, 255, 0.16);
    --glass: rgba(18, 20, 46, 0.75);
}

* {
    box-sizing: border-box;
}

body,
html {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    font-family: var(--font-sans);
    background: #000;
    color: var(--text-primary);
    overflow: hidden;
}

#app {
    position: relative;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 20%, rgba(255, 123, 193, 0.15), transparent 45%),
        radial-gradient(circle at 80% 10%, rgba(126, 148, 255, 0.15), transparent 55%);
}

#app::before,
#app::after {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
}

#app::before {
    background: linear-gradient(135deg, rgba(23, 25, 45, 0.6), transparent 60%),
        linear-gradient(315deg, rgba(27, 29, 58, 0.55), transparent 65%);
    mix-blend-mode: screen;
}

#app::after {
    background: radial-gradient(circle at center, transparent 55%, rgba(3, 6, 18, 0.65));
}

.aurora-band {
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, rgba(255, 123, 193, 0.12), transparent 45%, rgba(126, 148, 255, 0.12));
    mix-blend-mode: screen;
    animation: aurora 16s ease-in-out infinite;
    pointer-events: none;
}

@keyframes aurora {
    0%,
    100% {
        transform: translateY(-6%) scale(1.05) rotate(0deg);
        opacity: 0.7;
    }
    50% {
        transform: translateY(6%) scale(1.08) rotate(1.5deg);
        opacity: 0.95;
    }
}

.particle-field {
    position: absolute;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
}

.particle-field span {
    position: absolute;
    width: 3px;
    height: 3px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.75), transparent 70%);
    border-radius: 50%;
    animation: twinkle linear infinite;
    opacity: 0.6;
}

@keyframes twinkle {
    0%,
    100% {
        transform: translateY(0) scale(1);
        opacity: 0.35;
    }
    50% {
        transform: translateY(-18px) scale(1.3);
        opacity: 0.85;
    }
}

.petal-layer {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
}

.petal {
    position: absolute;
    width: 22px;
    height: 12px;
    background: radial-gradient(circle at 30% 30%, rgba(255, 160, 208, 0.85), rgba(255, 95, 175, 0.2));
    border-radius: 50% 50% 45% 45%;
    filter: blur(0.2px);
    animation: petalFall linear infinite;
    opacity: 0.45;
}

@keyframes petalFall {
    0% {
        transform: translate3d(0, -120px, 0) rotate(0deg);
        opacity: 0;
    }
    20% {
        opacity: 0.5;
    }
    100% {
        transform: translate3d(-120px, 160vh, 0) rotate(180deg);
        opacity: 0;
    }
}

#camera-feed {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: saturate(1.1) contrast(1.05);
}

#sprite {
    position: absolute;
    bottom: 8vh;
    max-height: 80%;
    max-width: 40vw;
    pointer-events: none;
    transition: transform 0.3s ease;
    filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.35));
    animation: spriteFloat 16s ease-in-out infinite;
}

#sprite.right {
    right: 6vw;
    left: auto;
}

@keyframes spriteFloat {
    0%,
    100% {
        transform: translateY(0) scale(1);
    }
    50% {
        transform: translateY(-18px) scale(1.02);
    }
}

#sprite.left {
    left: 6vw;
    right: auto;
}

#ui-layer {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 2.5rem 3.5rem;
    pointer-events: none;
}

.ui-frame {
    position: absolute;
    inset: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 36px;
    pointer-events: none;
    box-shadow: inset 0 0 40px rgba(255, 255, 255, 0.08), 0 0 40px rgba(116, 90, 255, 0.12);
    backdrop-filter: blur(6px);
    overflow: hidden;
}

.ui-frame::before {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 20% 30%, rgba(255, 123, 193, 0.22), transparent 60%),
        radial-gradient(circle at 80% 80%, rgba(107, 199, 255, 0.22), transparent 60%);
    opacity: 0.65;
}

.ui-frame::after {
    content: "";
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
        0deg,
        rgba(255, 255, 255, 0.04) 0px,
        rgba(255, 255, 255, 0.04) 2px,
        transparent 2px,
        transparent 4px
    );
    mix-blend-mode: overlay;
    opacity: 0.5;
}

.frame-corner {
    position: absolute;
    width: 72px;
    height: 72px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 24px;
    opacity: 0.5;
    box-shadow: 0 0 18px rgba(107, 199, 255, 0.4);
}

.frame-corner::after {
    content: "";
    position: absolute;
    inset: 10px;
    border: 2px solid rgba(255, 123, 193, 0.45);
    border-radius: 20px;
    filter: blur(0.5px);
}

.ui-frame .scanline {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, transparent, rgba(255, 255, 255, 0.22), transparent);
    opacity: 0.4;
    animation: sweep 7s linear infinite;
}

@keyframes sweep {
    0% {
        transform: translateY(-100%);
    }
    100% {
        transform: translateY(100%);
    }
}

.frame-corner.top-left {
    top: -1.5rem;
    left: -1.5rem;
    border-bottom: none;
    border-right: none;
}

.frame-corner.top-right {
    top: -1.5rem;
    right: -1.5rem;
    border-bottom: none;
    border-left: none;
}

.frame-corner.bottom-left {
    bottom: -1.5rem;
    left: -1.5rem;
    border-top: none;
    border-right: none;
}

.frame-corner.bottom-right {
    bottom: -1.5rem;
    right: -1.5rem;
    border-top: none;
    border-left: none;
}

.floating-ribbon {
    position: absolute;
    width: 220px;
    height: 220px;
    background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4), transparent 65%),
        conic-gradient(from 180deg, rgba(255, 123, 193, 0.18), rgba(126, 148, 255, 0.18), transparent 65%);
    filter: blur(18px);
    opacity: 0.5;
    animation: drift 14s infinite ease-in-out;
}

.floating-ribbon.r1 {
    top: 12%;
    left: 8%;
}

.floating-ribbon.r2 {
    bottom: 18%;
    right: 10%;
    animation-delay: 3s;
}

.floating-ribbon.r3 {
    top: 35%;
    right: 20%;
    animation-delay: 6s;
}

@keyframes drift {
    0%,
    100% {
        transform: translate3d(0, 0, 0) scale(1);
    }
    50% {
        transform: translate3d(30px, -25px, 0) scale(1.1);
    }
}

.top-interface {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: 1.5rem;
    pointer-events: auto;
    position: relative;
}

.brand-crest {
    display: flex;
    align-items: center;
    gap: 0.85rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, rgba(22, 26, 62, 0.85), rgba(46, 54, 102, 0.8));
    border-radius: 999px;
    box-shadow: 0 18px 28px rgba(0, 0, 0, 0.35), inset 0 0 22px rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.08);
    position: relative;
    overflow: hidden;
}

.crest-text {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
}

.brand-crest::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, rgba(255, 255, 255, 0.22), transparent 45%);
    opacity: 0.6;
    transform: translateX(-40%);
}

.brand-crest strong {
    font-family: var(--font-serif);
    font-size: 1.1rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
}

.brand-crest .crest-text span {
    display: block;
    font-size: 0.65rem;
    opacity: 0.72;
    letter-spacing: 0.28em;
}

.crest-icon {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: conic-gradient(from 180deg, rgba(255, 123, 193, 0.85), rgba(116, 90, 255, 0.85), rgba(255, 211, 157, 0.9));
    position: relative;
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
}

.crest-icon::after {
    content: "";
    position: absolute;
    inset: 6px;
    border-radius: 50%;
    background: rgba(8, 11, 26, 0.85);
    box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.18);
}

.crest-icon::before {
    content: "✶";
    font-size: 1.35rem;
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    color: var(--accent-gold);
    text-shadow: 0 0 12px rgba(255, 211, 157, 0.8);
}

.info-badges {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.info-chip {
    display: grid;
    place-content: center;
    padding: 0.55rem 1.35rem 0.55rem 1.1rem;
    border-radius: 16px;
    background: rgba(18, 21, 48, 0.75);
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
    min-width: 140px;
    position: relative;
    overflow: hidden;
}

.info-chip::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255, 123, 193, 0.32), rgba(116, 90, 255, 0.2));
    opacity: 0.75;
    mix-blend-mode: screen;
}

.info-chip .label {
    font-size: 0.65rem;
    letter-spacing: 0.32em;
    text-transform: uppercase;
    opacity: 0.65;
}

.info-chip .value {
    font-size: 0.95rem;
    font-weight: 600;
    margin-top: 0.2rem;
    letter-spacing: 0.08em;
}

.top-bar {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    align-items: center;
}

.top-bar button,
.top-bar select,
.top-bar input[type="file"]::file-selector-button {
    background: linear-gradient(130deg, rgba(255, 123, 193, 0.88), rgba(116, 90, 255, 0.88));
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 999px;
    padding: 0.55rem 1.4rem;
    color: var(--text-primary);
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
    transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
}

.top-bar label {
    display: inline-flex;
    flex-direction: column;
    gap: 0.3rem;
    font-size: 0.75rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.65);
    background: rgba(18, 22, 48, 0.75);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 0.55rem 0.95rem 0.7rem;
    box-shadow: 0 12px 22px rgba(0, 0, 0, 0.35);
}

.top-bar label span {
    font-size: 0.7rem;
    letter-spacing: 0.22em;
    opacity: 0.85;
}

.top-bar select {
    appearance: none;
    background: linear-gradient(130deg, rgba(35, 43, 90, 0.92), rgba(21, 26, 60, 0.92));
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 999px;
    padding: 0.55rem 2.2rem 0.55rem 1.1rem;
    min-width: 130px;
    color: var(--text-primary);
    font-weight: 600;
    letter-spacing: 0.08em;
    cursor: pointer;
    position: relative;
    box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.08);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23ffffff' fill-opacity='0.8' d='M1.41 0L6 4.58 10.59 0 12 1.41l-6 6-6-6z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.9rem center;
}

.top-bar select option {
    color: #111226;
}

.top-bar input[type="file"] {
    color: transparent;
    width: 160px;
}

.top-bar input[type="file"]::file-selector-button {
    margin-right: -1rem;
}

.top-bar button.active {
    box-shadow: 0 0 0 2px rgba(107, 199, 255, 0.55), 0 12px 30px rgba(0, 0, 0, 0.55);
    filter: saturate(1.1);
}

.top-bar button:hover,
.top-bar select:hover,
.top-bar input[type="file"]::file-selector-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 32px rgba(0, 0, 0, 0.45);
}

.dialogue-area {
    pointer-events: none;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: center;
    margin-bottom: 2vh;
    position: relative;
}

.dialogue-area::before {
    content: "";
    position: absolute;
    bottom: 6vh;
    width: 62vw;
    max-width: 820px;
    height: 36vh;
    background: radial-gradient(ellipse at bottom, rgba(9, 15, 35, 0.75), transparent 70%),
        radial-gradient(circle at 40% 40%, rgba(255, 123, 193, 0.18), transparent 65%);
    filter: blur(28px);
    z-index: -1;
}

.dialogue-area::after {
    content: "";
    position: absolute;
    inset: auto 50% 3.5rem;
    width: min(580px, 90vw);
    height: 2px;
    transform: translateX(-50%);
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.35), transparent);
    opacity: 0.8;
}

.dialogue-box {
    width: min(960px, 85vw);
    background: linear-gradient(170deg, rgba(25, 30, 66, 0.92), rgba(12, 16, 34, 0.92));
    border-radius: 26px;
    border: 1px solid rgba(255, 255, 255, 0.16);
    padding: 2.1rem 2.25rem 2.4rem;
    position: relative;
    overflow: hidden;
    pointer-events: auto;
    box-shadow: 0 24px 55px rgba(0, 0, 0, 0.55), inset 0 0 25px rgba(255, 255, 255, 0.05);
}

.dialogue-box::before {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top left, rgba(255, 123, 193, 0.28), transparent 60%),
        radial-gradient(circle at top right, rgba(126, 148, 255, 0.22), transparent 60%);
    mix-blend-mode: screen;
    opacity: 0.8;
}

.dialogue-box::after {
    content: "";
    position: absolute;
    inset: 12px;
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    pointer-events: none;
    box-shadow: inset 0 0 35px rgba(255, 123, 193, 0.12), inset 0 0 18px rgba(107, 199, 255, 0.12);
}

.dialogue-box .ornament-strip {
    position: absolute;
    inset: 0;
    background: linear-gradient(110deg, rgba(255, 255, 255, 0.08), transparent 35%),
        linear-gradient(290deg, rgba(255, 255, 255, 0.05), transparent 45%);
    opacity: 0.6;
    pointer-events: none;
}

.nameplate {
    font-family: var(--font-serif);
    font-size: 1.35rem;
    letter-spacing: 0.18em;
    color: var(--accent-gold);
    margin-bottom: 0.85rem;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.55);
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.85rem;
    padding: 0.4rem 1.4rem;
    border-radius: 999px;
    background: linear-gradient(120deg, rgba(255, 255, 255, 0.05), transparent 40%);
    border: 1px solid rgba(255, 217, 159, 0.28);
    box-shadow: inset 0 0 12px rgba(255, 217, 159, 0.12), 0 8px 18px rgba(0, 0, 0, 0.25);
}

.nameplate::before,
.nameplate::after {
    content: "";
    height: 1px;
    flex: 1 1 42px;
    background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 217, 159, 0.65));
    opacity: 0.9;
}

.nameplate::after {
    background: linear-gradient(270deg, rgba(255, 255, 255, 0), rgba(255, 217, 159, 0.65));
}

.dialogue-text {
    font-size: 1.15rem;
    line-height: 1.9;
    color: var(--text-secondary);
    min-height: 4.75rem;
    position: relative;
    letter-spacing: 0.03em;
}

.dialogue-text::after {
    content: "“";
    position: absolute;
    top: -1.25rem;
    left: -1rem;
    font-size: 3rem;
    color: rgba(255, 255, 255, 0.05);
    pointer-events: none;
}

.cursor {
    display: inline-block;
    margin-left: 0.3rem;
    animation: blink 1s infinite;
    color: var(--accent);
}

@keyframes blink {
    0%, 50% {
        opacity: 1;
    }
    51%, 100% {
        opacity: 0;
    }
}

.options {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
    pointer-events: auto;
    padding: 0.5rem 1rem 0;
}

.option-button {
    position: relative;
    background: linear-gradient(135deg, rgba(255, 123, 193, 0.92), rgba(126, 148, 255, 0.92));
    color: var(--text-primary);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 20px;
    padding: 1rem 2.2rem 1rem 1.4rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
    transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
    letter-spacing: 0.06em;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
}

.option-button:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    filter: saturate(1.08);
}

.option-button::after {
    content: "";
    position: absolute;
    top: 50%;
    right: 1.2rem;
    width: 9px;
    height: 9px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0));
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
    transform: translateY(-50%);
}

.modal {
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    background: rgba(10, 12, 26, 0.7);
    backdrop-filter: blur(6px);
    transition: opacity 0.25s ease;
    pointer-events: auto;
    z-index: 999;
}

.modal.hidden {
    opacity: 0;
    pointer-events: none;
}

.modal-content {
    background: linear-gradient(160deg, rgba(255, 95, 95, 0.95), rgba(179, 32, 67, 0.95));
    border-radius: 28px;
    padding: 2rem 3rem;
    text-align: center;
    color: #fff5f5;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
}

.modal-content button {
    margin-top: 1.5rem;
    padding: 0.75rem 2.5rem;
    border-radius: 999px;
    border: none;
    background: rgba(255, 255, 255, 0.9);
    color: #c2113a;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
}

.history-panel {
    position: absolute;
    right: 3rem;
    top: 7rem;
    width: min(340px, 60vw);
    max-height: min(55vh, 440px);
    background: linear-gradient(180deg, rgba(22, 28, 64, 0.92), rgba(15, 18, 44, 0.92));
    border: 1.5px solid rgba(255, 255, 255, 0.16);
    border-radius: 26px;
    padding: 1.4rem 1.6rem;
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
    box-shadow: 0 22px 50px rgba(0, 0, 0, 0.55);
    backdrop-filter: blur(14px);
    pointer-events: auto;
    transform: translateY(-10px);
    opacity: 1;
    transition: opacity 0.2s ease, transform 0.25s ease;
    overflow: hidden;
}

.history-panel::before {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(107, 199, 255, 0.22), transparent 60%),
        radial-gradient(circle at bottom left, rgba(255, 123, 193, 0.18), transparent 60%);
    opacity: 0.7;
    pointer-events: none;
}

.history-panel::after {
    content: "";
    position: absolute;
    inset: 12px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.06);
    pointer-events: none;
}

.history-panel.hidden {
    opacity: 0;
    pointer-events: none;
    transform: translateY(-24px);
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-family: var(--font-serif);
    letter-spacing: 0.12em;
    color: var(--accent-gold);
    border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    padding-bottom: 0.65rem;
    position: relative;
    z-index: 1;
}

.history-header button {
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.18);
    color: var(--text-primary);
    font-size: 1.1rem;
    cursor: pointer;
    opacity: 0.75;
    transition: transform 0.2s ease, opacity 0.2s ease;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: grid;
    place-items: center;
}

.history-header button:hover {
    opacity: 1;
    transform: rotate(90deg);
}

.history-list {
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding-right: 0.5rem;
    scrollbar-width: thin;
    position: relative;
    z-index: 1;
}

.history-entry {
    background: rgba(12, 16, 38, 0.85);
    border-radius: 18px;
    padding: 0.85rem 1rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: inset 0 0 18px rgba(255, 255, 255, 0.05);
    position: relative;
    overflow: hidden;
}

.history-entry::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, rgba(255, 255, 255, 0.06), transparent 45%);
    opacity: 0.8;
    pointer-events: none;
}

.history-entry .speaker {
    font-family: var(--font-serif);
    font-size: 0.95rem;
    color: var(--accent);
    margin-bottom: 0.3rem;
    letter-spacing: 0.05em;
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.45);
}

.history-entry .line {
    font-size: 0.95rem;
    color: var(--text-secondary);
    line-height: 1.6;
    position: relative;
    z-index: 1;
    letter-spacing: 0.02em;
}

.history-list::-webkit-scrollbar {
    width: 6px;
}

.history-list::-webkit-scrollbar-thumb {
    background: rgba(255, 123, 193, 0.45);
    border-radius: 999px;
}

@media (max-width: 768px) {
    #ui-layer {
        padding: 1.5rem;
    }

    .top-interface {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .info-badges {
        flex-wrap: wrap;
        justify-content: flex-start;
    }

    .top-bar {
        flex-wrap: wrap;
        justify-content: flex-start;
    }

    .top-bar label {
        width: calc(50% - 0.5rem);
    }

    .dialogue-box {
        width: 95vw;
    }

    .history-panel {
        right: 50%;
        transform: translate(50%, -10px);
        width: 90vw;
        max-height: 60vh;
    }

    #sprite {
        max-width: 70vw;
    }
}
    </style>
</head>
<body>
    <div id="app">
        <video id="camera-feed" autoplay playsinline muted></video>
        <img id="sprite" alt="角色立绘" src="" hidden />
        <div id="ui-layer">
            <div class="ui-frame">
                <span class="frame-corner top-left"></span>
                <span class="frame-corner top-right"></span>
                <span class="frame-corner bottom-left"></span>
                <span class="frame-corner bottom-right"></span>
                <span class="scanline"></span>
            </div>
            <div class="aurora-band"></div>
            <div class="particle-field">
                <span style="top: 12%; left: 18%; animation-duration: 8s; animation-delay: 0.5s"></span>
                <span style="top: 28%; left: 72%; animation-duration: 10s; animation-delay: 2s"></span>
                <span style="top: 45%; left: 35%; animation-duration: 9s; animation-delay: 1.2s"></span>
                <span style="top: 60%; left: 15%; animation-duration: 11s; animation-delay: 3s"></span>
                <span style="top: 70%; left: 68%; animation-duration: 13s; animation-delay: 0.8s"></span>
                <span style="top: 20%; left: 50%; animation-duration: 12s; animation-delay: 4s"></span>
                <span style="top: 82%; left: 42%; animation-duration: 14s; animation-delay: 2.8s"></span>
                <span style="top: 38%; left: 5%; animation-duration: 9.5s; animation-delay: 1.5s"></span>
                <span style="top: 15%; left: 88%; animation-duration: 11.5s; animation-delay: 0.2s"></span>
                <span style="top: 52%; left: 82%; animation-duration: 10.5s; animation-delay: 3.6s"></span>
                <span style="top: 76%; left: 24%; animation-duration: 12.4s; animation-delay: 1s"></span>
                <span style="top: 33%; left: 60%; animation-duration: 9.8s; animation-delay: 2.4s"></span>
            </div>
            <div class="petal-layer">
                <span class="petal" style="left: 10%; animation-duration: 14s; animation-delay: 0s"></span>
                <span class="petal" style="left: 22%; animation-duration: 12s; animation-delay: 2s"></span>
                <span class="petal" style="left: 58%; animation-duration: 13.5s; animation-delay: 1s"></span>
                <span class="petal" style="left: 74%; animation-duration: 11.5s; animation-delay: 3s"></span>
                <span class="petal" style="left: 88%; animation-duration: 12.8s; animation-delay: 1.5s"></span>
                <span class="petal" style="left: 36%; animation-duration: 15s; animation-delay: 4s"></span>
            </div>
            <div class="floating-ribbon r1"></div>
            <div class="floating-ribbon r2"></div>
            <div class="floating-ribbon r3"></div>

            <header class="top-interface">
                <div class="brand-crest">
                    <span class="crest-icon"></span>
                    <div class="crest-text">
                        <strong>STELLAR LINK</strong>
                        <span>GALGAME LIVE</span>
                    </div>
                </div>
                <div class="info-badges">
                    <div class="info-chip">
                        <span class="label">SCENE</span>
                        <span class="value" id="scene-label">都市·黄昏</span>
                    </div>
                    <div class="info-chip">
                        <span class="label">TIME</span>
                        <span class="value" id="time-label">--:--</span>
                    </div>
                </div>
                <div class="top-bar">
                    <button id="switch-camera">切换摄像头</button>
                    <button id="toggle-history">历史对话</button>
                    <label class="character-toggle">
                        <span>角色位置</span>
                        <select id="sprite-position">
                            <option value="left">左侧</option>
                            <option value="right">右侧</option>
                        </select>
                    </label>
                    <label class="sprite-selector">
                        <span>立绘</span>
                        <input id="sprite-file" type="file" accept="image/png,image/webp,image/jpeg" />
                    </label>
                </div>
            </header>

            <main class="dialogue-area">
                <div class="dialogue-box">
                    <span class="ornament-strip"></span>
                    <div class="nameplate" id="speaker-name">???</div>
                    <div class="dialogue-text">
                        <span id="subtitle"></span>
                        <span class="cursor" id="type-cursor">▋</span>
                    </div>
                </div>
                <div class="options" id="options"></div>
            </main>
            <aside class="history-panel hidden" id="history-panel">
                <div class="history-header">
                    <span>历史对话</span>
                    <button id="close-history" aria-label="关闭历史面板">×</button>
                </div>
                <div class="history-list" id="history-list"></div>
            </aside>
        </div>
    </div>

    <div class="modal hidden" id="gender-warning">
        <div class="modal-content">
            <h2>性别警告</h2>
            <p>小心我把你送到成都！</p>
            <button id="close-warning">我知道了</button>
        </div>
    </div>

    <template id="option-template">
        <button class="option-button"></button>
    </template>

    <script type="module">
const cameraFeed = document.getElementById('camera-feed');
const spriteImage = document.getElementById('sprite');
const switchCameraBtn = document.getElementById('switch-camera');
const spritePositionSelect = document.getElementById('sprite-position');
const spriteFileInput = document.getElementById('sprite-file');
const subtitleSpan = document.getElementById('subtitle');
const cursorSpan = document.getElementById('type-cursor');
const namePlate = document.getElementById('speaker-name');
const optionsContainer = document.getElementById('options');
const optionTemplate = document.getElementById('option-template');
const genderWarning = document.getElementById('gender-warning');
const closeWarningBtn = document.getElementById('close-warning');
const toggleHistoryBtn = document.getElementById('toggle-history');
const historyPanel = document.getElementById('history-panel');
const closeHistoryBtn = document.getElementById('close-history');
const historyList = document.getElementById('history-list');
const sceneLabel = document.getElementById('scene-label');
const timeLabel = document.getElementById('time-label');

let mediaStream = null;
let facingMode = 'user';
let genderIntervalId = null;
let asrSocket = null;
let mediaRecorder = null;
let typewriterController = null;
let latestTranscript = '';
const dialogueHistory = [];

const MAX_HISTORY_ITEMS = 80;

const TYPE_SPEED = 32;
const GENDER_CHECK_INTERVAL = 3000;
const QUESTION_TRIGGER_PATTERN = /[?？吗麼嘛呢吧]/;

const SCENE_PRESETS = {
    left: '都市·黄昏',
    right: '天台·深夜',
};

function updateClockBadge() {
    if (!timeLabel) return;
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    timeLabel.textContent = `${hours}:${minutes}`;
}

function applyScenePreset(position) {
    if (!sceneLabel) return;
    sceneLabel.textContent = SCENE_PRESETS[position] ?? SCENE_PRESETS.left;
}

function log(...args) {
    console.debug('[Agent]', ...args);
}

async function initCamera() {
    if (!navigator.mediaDevices?.getUserMedia) {
        alert('当前浏览器不支持摄像头访问');
        return;
    }

    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode },
            audio: true,
        });
        cameraFeed.srcObject = mediaStream;
        startAudioStreaming(mediaStream);
        startGenderGuard();
    } catch (err) {
        console.error('获取摄像头失败', err);
        alert('无法访问摄像头/麦克风: ' + err.message);
    }
}

async function switchCamera() {
    facingMode = facingMode === 'user' ? 'environment' : 'user';
    if (mediaStream) {
        mediaStream.getTracks().forEach((track) => track.stop());
    }
    await initCamera();
}

function applySpritePosition(position) {
    spriteImage.classList.remove('left', 'right');
    spriteImage.classList.add(position);
    applyScenePreset(position);
}

spritePositionSelect.addEventListener('change', (event) => {
    applySpritePosition(event.target.value);
});

updateClockBadge();
setInterval(updateClockBadge, 60000);
if (spritePositionSelect) {
    applySpritePosition(spritePositionSelect.value);
}

spriteFileInput.addEventListener('change', (event) => {
    const file = event.target.files?.[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    spriteImage.src = url;
    spriteImage.hidden = false;
});

switchCameraBtn.addEventListener('click', () => {
    switchCamera().catch((err) => console.error(err));
});

closeWarningBtn.addEventListener('click', () => {
    genderWarning.classList.add('hidden');
});

function openHistoryPanel() {
    if (!historyPanel || !toggleHistoryBtn) return;
    historyPanel.classList.remove('hidden');
    toggleHistoryBtn.classList.add('active');
}

function closeHistoryPanel() {
    if (!historyPanel || !toggleHistoryBtn) return;
    historyPanel.classList.add('hidden');
    toggleHistoryBtn.classList.remove('active');
}

toggleHistoryBtn?.addEventListener('click', () => {
    if (historyPanel?.classList.contains('hidden')) {
        openHistoryPanel();
    } else {
        closeHistoryPanel();
    }
});

closeHistoryBtn?.addEventListener('click', () => {
    closeHistoryPanel();
});

document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
        closeHistoryPanel();
    }
});

function typewrite(text) {
    if (typewriterController) {
        typewriterController.abort();
    }

    subtitleSpan.textContent = '';
    cursorSpan.style.visibility = 'visible';

    const controller = new AbortController();
    typewriterController = controller;

    (async () => {
        for (const char of text) {
            if (controller.signal.aborted) return;
            subtitleSpan.textContent += char;
            await new Promise((resolve) => setTimeout(resolve, TYPE_SPEED));
        }
        cursorSpan.style.visibility = 'hidden';
    })();
}

function setOptions(options) {
    optionsContainer.innerHTML = '';
    if (!Array.isArray(options) || !options.length) return;

    options.forEach((option) => {
        const button = optionTemplate.content.firstElementChild.cloneNode(true);
        button.textContent = option.text;
        button.addEventListener('click', () => handleOptionSelected(option));
        optionsContainer.appendChild(button);
    });
}

async function handleOptionSelected(option) {
    log('Option selected', option);
    try {
        const response = await fetch('/gpt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ option: option.id, history: latestTranscript }),
        });
        if (!response.ok) throw new Error('选项提交失败');
        const data = await response.json();
        updateDialogue(data.text ?? '……', data.speaker ?? '系统');
        setOptions(data.options ?? []);
    } catch (error) {
        console.error(error);
    }
}

function updateDialogue(text, speaker = '？？？') {
    namePlate.textContent = speaker;
    typewrite(text);
    appendHistoryEntry(speaker, text);
}

function appendHistoryEntry(speaker, text) {
    const normalizedSpeaker = speaker?.trim() || '？？？';
    const normalizedText = text?.trim();
    if (!normalizedText || !historyList) return;

    const lastEntry = dialogueHistory[dialogueHistory.length - 1];
    if (lastEntry && lastEntry.text === normalizedText && lastEntry.speaker === normalizedSpeaker) {
        return;
    }

    dialogueHistory.push({ speaker: normalizedSpeaker, text: normalizedText });

    const entry = document.createElement('div');
    entry.className = 'history-entry';

    const speakerEl = document.createElement('div');
    speakerEl.className = 'speaker';
    speakerEl.textContent = normalizedSpeaker;

    const lineEl = document.createElement('div');
    lineEl.className = 'line';
    lineEl.textContent = normalizedText;

    entry.append(speakerEl, lineEl);
    historyList.appendChild(entry);

    if (dialogueHistory.length > MAX_HISTORY_ITEMS) {
        dialogueHistory.shift();
        historyList.firstElementChild?.remove();
    }

    historyList.scrollTop = historyList.scrollHeight;
}

function startAudioStreaming(stream) {
    if (mediaRecorder) {
        mediaRecorder.stop();
        mediaRecorder = null;
    }
    if (asrSocket) {
        asrSocket.close();
        asrSocket = null;
    }

    try {
        const audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(stream);
        const destination = audioContext.createMediaStreamDestination();
        source.connect(destination);

        mediaRecorder = new MediaRecorder(destination.stream, { mimeType: 'audio/webm' });
        const wsUrl = `${location.origin.replace(/^http/, 'ws')}/ws_asr`;
        asrSocket = new WebSocket(wsUrl);

        asrSocket.binaryType = 'arraybuffer';

        asrSocket.addEventListener('open', () => {
            log('ASR WebSocket connected');
            mediaRecorder.start(500);
        });

        asrSocket.addEventListener('message', async (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.text) {
                    latestTranscript = data.text;
                    updateDialogue(data.text, data.speaker || '主角');
                    if (QUESTION_TRIGGER_PATTERN.test(data.text)) {
                        await requestBranchOptions(data.text);
                    }
                }
                if (data.options) {
                    setOptions(data.options);
                }
            } catch (err) {
                console.error('解析ASR消息失败', err);
            }
        });

        asrSocket.addEventListener('close', () => {
            log('ASR WebSocket closed');
            mediaRecorder?.stop();
        });

        mediaRecorder.addEventListener('dataavailable', (event) => {
            if (event.data?.size && asrSocket?.readyState === WebSocket.OPEN) {
                event.data.arrayBuffer().then((buffer) => {
                    asrSocket.send(buffer);
                });
            }
        });
    } catch (err) {
        console.error('初始化音频流失败', err);
    }
}

async function requestBranchOptions(text) {
    try {
        const response = await fetch('/gpt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: text }),
        });
        if (!response.ok) throw new Error('剧情生成失败');
        const data = await response.json();
        if (data.text) updateDialogue(data.text, data.speaker || 'AI同伴');
        if (data.options) setOptions(data.options);
    } catch (error) {
        console.error('请求剧情分支失败', error);
    }
}

function showGenderWarning() {
    genderWarning.classList.remove('hidden');
}

async function checkGender() {
    if (!cameraFeed.videoWidth || !cameraFeed.videoHeight) return;

    const canvas = document.createElement('canvas');
    canvas.width = cameraFeed.videoWidth;
    canvas.height = cameraFeed.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);

    const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', 0.7));
    if (!blob) return;

    try {
        const response = await fetch('/yolo_gender', {
            method: 'POST',
            body: blob,
        });
        if (!response.ok) throw new Error('性别识别失败');
        const result = await response.json();
        if (result.class && result.class !== 'female' && (result.confidence ?? 0) > 0.7) {
            showGenderWarning();
        }
    } catch (error) {
        console.error('YOLO识别异常', error);
    }
}

function startGenderGuard() {
    if (genderIntervalId) {
        clearInterval(genderIntervalId);
    }
    genderIntervalId = setInterval(checkGender, GENDER_CHECK_INTERVAL);
}

function init() {
    applySpritePosition(spritePositionSelect.value);
    initCamera();
    updateDialogue('启动中……准备好进入现实Galgame的世界了吗？', '系统');
}

init();
    </script>
</body>
</html>
